<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Digital - Cendekia Aksara</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root { --primary: #003366; --secondary: #005a9c; --accent: #f0f4f8; --hadir: #28a745; --absen: #dc3545; --izin: #ffc107; --border: #dee2e6;}
        body { font-family: 'Poppins', sans-serif; background-color: var(--accent); margin: 0; padding: 20px; box-sizing: border-box; }
        .container { max-width: 800px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: var(--primary); text-align: center; }
        .hidden { display: none !important; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; color: #fff; background-color: var(--secondary); font-weight: 600; cursor: pointer; transition: background-color 0.2s; font-size: 1em; }
        .btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .class-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .student-list { list-style: none; padding: 0; }
        .student-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); }
        .student-item:last-child { border-bottom: none; }
        .status-circles { display: flex; gap: 10px; }
        .status-circle { width: 24px; height: 24px; border-radius: 50%; background-color: #ccc; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .status-circle:hover { transform: scale(1.2); }
        .status-circle.hadir { background-color: var(--hadir); }
        .status-circle.absen { background-color: var(--absen); }
        .status-circle.izin { background-color: var(--izin); }
        .status-circle.active { border-color: var(--primary); transform: scale(1.2); }
        #report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #report-table th, #report-table td { border: 1px solid var(--border); padding: 10px; text-align: left; }
        #report-table th { background-color: var(--accent); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; }
        #loading-overlay p { margin-top: 15px; font-size: 1.2em; font-weight: 600; color: var(--primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media print { body * { visibility: hidden; } #report-view, #report-view * { visibility: visible; } #report-view { position: absolute; left: 0; top: 0; margin: 0; } .btn { display: none; } }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="login-view" class="view container">
            <h1>Portal Presensi Digital</h1>
            <p>Silakan masukkan nama lengkap Anda untuk memulai sesi presensi.</p>
            <form id="login-form">
                <div class="form-group"><label for="nama-pengajar">Nama Lengkap Pengajar</label><input type="text" id="nama-pengajar" required></div>
                <button type="submit" class="btn">Masuk</button>
            </form>
        </div>

        <div id="class-selection-view" class="view container hidden">
            <h2>Pilih Kelas</h2>
            <p>Pilih kelas yang akan Anda lakukan presensi.</p>
            <div class="class-selection">
                <button class="btn" data-kelas="Kelas A">Kelas A</button>
                <button class="btn" data-kelas="Kelas B">Kelas B</button>
            </div>
        </div>

        <div id="attendance-view" class="view container hidden">
            <h2 id="attendance-header">Presensi Kelas A</h2>
            <ul id="student-list" class="student-list"></ul>
            <button id="next-btn" class="btn" style="margin-top: 20px;">Berikutnya</button>
        </div>

        <div id="session-info-view" class="view container hidden">
            <h2>Informasi Sesi</h2>
            <form id="session-info-form">
                <div class="form-group"><label for="matkul">Mata Pelajaran yang Diampu</label><input type="text" id="matkul" required></div>
                <button type="submit" class="btn">Simpan & Buat Laporan</button>
            </form>
        </div>

        <div id="report-view" class="view container hidden">
            <div id="report-content">
                <h2 id="report-header">Laporan Presensi</h2>
                <p id="report-subheader"></p>
                <table id="report-table">
                    <thead><tr><th>No.</th><th>Nama Siswa</th><th>Status</th></tr></thead>
                    <tbody id="report-table-body"></tbody>
                </table>
            </div>
            <button id="get-pdf-btn" class="btn" style="margin-top:20px; background-color: #28a745;">Dapatkan PDF</button>
        </div>
    </div>
    
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p id="loading-text">Memuat...</p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- PENTING: GANTI DENGAN URL SCRIPT PRESENSI ANDA ---
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyWoFzAJK63TMhYXTYjd6gATf_P_Xqic6a4x2loNvhDYaBVcJ0x2xjw5C6cu44t0a1nqA/exec';
    
    // --- DATABASE NAMA SISWA ---
    const dataSiswa = {
        "Kelas A": ["Aghniya Hawa Laila Tsaliyanti", "Ambarwati Friska Panigoro", "Anita Khoirun Nufus", "Aqilah Khairunnisa", "Bunga Permatasari Anjayani", "Fatimah Zahara Siregar", "Ika amalia", "Jelo Octariana Sari", "LINDA WARDANI", "List", "M. Arjun Naja", "Mianis Nur Rahayu", "Nadia Fatimah Azzahra", "Nur ayatul husna", "Rabby Radhiya", "Raysah Rahmania"],
        "Kelas B": ["Aisha Rafidah", "Ani Septiana", "Anna", "Atha Naufal mas uud", "Dyah Safitri", "Gita purnama", "Indah Cahyani Saharani", "Khofifah Dwi Apriyani", "Lisdawati", "livia Isnaieny Rahmadani", "Maharani Mochtar", "Nabila Saki Rati", "Naqita Pratami Putri", "Queena paramitha supriyadi", "Rahmadhany", "Rina Khusnia Fahma"]
    };

    let sessionData = { pengajar: '', kelas: '', matkul: '', presensi: {} };

    // --- Seleksi Elemen ---
    const allViews = document.querySelectorAll('.view');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');

    // --- Fungsi Bantuan ---
    function showView(viewId) { allViews.forEach(v => v.classList.add('hidden')); document.getElementById(viewId).classList.remove('hidden'); }
    function showLoading(message) { loadingText.textContent = message; loadingOverlay.classList.remove('hidden'); }
    function hideLoading() { loadingOverlay.classList.add('hidden'); }

    // --- Alur Aplikasi ---

    // 1. Login Pengajar
    document.getElementById('login-form').onsubmit = (e) => {
        e.preventDefault();
        sessionData.pengajar = document.getElementById('nama-pengajar').value;
        showLoading('Menyiapkan sesi...');
        setTimeout(() => { hideLoading(); showView('class-selection-view'); }, 500);
    };

    // 2. Pilih Kelas
    document.querySelector('.class-selection').onclick = (e) => {
        if (e.target.matches('.btn')) {
            sessionData.kelas = e.target.dataset.kelas;
            renderAttendanceList(sessionData.kelas);
            showView('attendance-view');
        }
    };

    function renderAttendanceList(className) { /* ... (fungsi ini tidak berubah) ... */ }
    document.getElementById('student-list').onclick = (e) => { /* ... (fungsi ini tidak berubah) ... */ };
    document.getElementById('next-btn').onclick = () => showView('session-info-view');

    // 3. Mengisi Info Sesi & MENYIMPAN DATA (PERUBAHAN UTAMA)
    document.getElementById('session-info-form').onsubmit = (e) => {
        e.preventDefault();
        sessionData.matkul = document.getElementById('matkul').value;
        showLoading('Menyimpan data presensi...');
        
        // Kirim data ke Google Apps Script
        fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify(sessionData) // Kirim semua data sesi
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // Jika berhasil disimpan, baru tampilkan laporan
                renderReportView();
                showView('report-view');
            } else {
                alert("Gagal menyimpan data ke Google Sheet. " + data.message);
            }
        })
        .catch(err => {
            console.error("Error:", err);
            alert("Terjadi kesalahan jaringan. Gagal menyimpan data.");
        })
        .finally(() => {
            hideLoading();
        });
    };
    
    // 4. Menampilkan Laporan & Unduh PDF (tidak berubah)
    function renderReportView() { /* ... (fungsi ini tidak berubah) ... */ }
    document.getElementById('get-pdf-btn').onclick = () => { /* ... (fungsi ini tidak berubah) ... */ };

    // --- Implementasi fungsi-fungsi yang tidak berubah ---
    function renderAttendanceList(className) {
        document.getElementById('attendance-header').textContent = `Presensi ${className}`;
        const listContainer = document.getElementById('student-list');
        listContainer.innerHTML = '';
        dataSiswa[className].sort().forEach(nama => {
            sessionData.presensi[nama] = null;
            const listItem = document.createElement('li');
            listItem.className = 'student-item';
            listItem.innerHTML = `<span>${nama}</span><div class="status-circles" data-nama="${nama}"><div class="status-circle hadir" data-status="Hadir" title="Hadir"></div><div class="status-circle absen" data-status="Absen" title="Absen"></div><div class="status-circle izin" data-status="Izin" title="Izin"></div></div>`;
            listContainer.appendChild(listItem);
        });
    }
    document.getElementById('student-list').onclick = (e) => {
        if (e.target.matches('.status-circle')) {
            const status = e.target.dataset.status;
            const nama = e.target.parentElement.dataset.nama;
            sessionData.presensi[nama] = status;
            e.target.parentElement.querySelectorAll('.status-circle').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
        }
    };
    function renderReportView() {
        document.getElementById('report-header').textContent = `Laporan Presensi - ${sessionData.matkul}`;
        document.getElementById('report-subheader').textContent = `Kelas ${sessionData.kelas} | Pengajar: ${sessionData.pengajar}`;
        const tableBody = document.getElementById('report-table-body');
        tableBody.innerHTML = '';
        Object.entries(sessionData.presensi).sort().forEach(([nama, status], index) => {
            const row = tableBody.insertRow();
            row.innerHTML = `<td>${index + 1}</td><td>${nama}</td><td>${status || 'Tidak Diabsen'}</td>`;
        });
    }
    document.getElementById('get-pdf-btn').onclick = () => {
        showLoading('Membuat file PDF...');
        const element = document.getElementById('report-content');
        const opt = { margin: 0.5, filename: `Presensi_${sessionData.kelas}_${sessionData.matkul}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas:  { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
        html2pdf().from(element).set(opt).save().then(() => {
            hideLoading();
            alert("PDF berhasil dibuat!");
            location.reload();
        });
    };
});
</script>
</body>
</html>
